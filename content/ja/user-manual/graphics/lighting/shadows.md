---
title: 影
template: usermanual-page.tmpl.html
position: 2
---

影を使用すればゲームにリアリティを加えることができます。しかし、動的な(リアルタイムな)影は、実行時のパフォーマンスに大きな負荷を加えてしまいます。パフォーマンスへの影響を少なく、シーンに静的な影を追加する方法については[Lightmaps][4]を参照してください。

![Characters with shadow casting][1]

PlayCanvasにはシャドウマッピングという影を生成するアルゴリズムが実装されています。プラットフォーム間の互換性があり、モバイル端末とデスクトップ両方で動作することが保証されています。さらに、影の機能は無料で誰でも使うことができます。ゲームの見栄えをよくするためにProアカウントを作る必要はありません。

## 影をつける

![指向性ライト][5]

PlayCanvasでは、デフォルトで影の生成は無効になっています。ですので、明示的に影生成を有効にする必要があります。影生成を有効にするのは簡単です。まず、シーンの中のどの光源で影を生成したいかを指定します。光源をツリー表示から選択し、インスペクタパネルからプロパティを編集してください。光源には'Cast Shadows'オプションがありますので、それをチェックすればその光源はシーンに存在するオブジェクトに対して影を生成するようになります。

![モデルコンポーネント][6]

シーン内で影を落とす又は受けるグラフィカルオブジェクトを指定する必要があります。デフォルトでは、すべてのモデルコンポーネントは影を受けるのみで、落としません。したがって、エンティティに影を落とさせるには、階層でエンティティを選択して、Inspectorでモデルコンポーネントを見つけて、「Cast Shadows」オプションにチェックを入れます。

これで、Editorのビューポートに影が表示されるはずです。

## 影のチューニング

PlayCanvasで使われているシャドウマッピングは有限の解像度しか持ちませんが、パラメータを調整することで見た目を良くすることができます。[Light Component][2] UIに次のプロパティがあります。

### 投影距離のチューニング

shadow distance（投影距離）はビューポイントから指向性ライトの影が描画されなくなる距離を決めるパラメータです。この値が小さければ小さいほど、影は鮮明になります。この値を小さくしすぎると、シーン内で視点を動かした時に突然影が現れるかもしれません。プレイヤーがどれだけ遠くを見るかという要素と、影がおおむねきれいに見えるバランスを考えて値を決めてください。

### 影野解像度

すべての光源はシャドウマップを使用して影を投影します。シャドウマップは256x256, 512x512, 1024x1024, 2048x2048のいずれかの解像度を設定できます。この値はlightコンポーネントのインタフェースにも設定できます。この解像度が高ければ高いほど、影は鮮明になります。ただし、高い解像度の影はレンダリングに時間がかかるため、パフォーマンスの影のクオリティのバランスを考えて設定してください。

### 影のバイアス

シャドウマッピングは非常に目立つ不自然な描画をする場合があります。もし影の帯や斑点状のノイズを見つけたら、影のバイアスを調整することで解決する場合があります。

### 法線方向のオフセットバイアス

'影の斑点'と呼ばれる不自然な表示は目立つ問題ですが、シャドウバイアスを調整して対処することができます。ただし、この調整をすると’ピーターパン現象'が発生し、影によって多少物体が浮いているように見えてしまうことがあります。

法線方向のオフセットバイアスによってこの問題に対処することができます。深さ方向のバイアスに加えて、シャドウマップの参照時に使われるUVマッピングをわずかに調整することで、影の斑点とピーターパン現象の二つを同時に避けることができます。フラグメントの位置を法線方向にずらす"法線方向のオフセット"はシャドウバイアスだけで問題に対処するよりも、大幅に見た目を改善します。

## Soft Shadow 対 Hard Shadow

影の輪郭はpenumbra（半影）と呼ばれています。これは、影に柔らかい輪郭を与える、暗から明への移行です。PlayCanvasのデフォルトでは、影の輪郭は柔らかく設定されていますが、この設定を変更することで輪郭を鋭くすることもできます。柔らかい輪郭と鋭い輪郭の比較は以下を参照してください。

![Soft Shadow 対 Hard Shadow][3]

柔らかい影はGPU上でシャドウマップのサンプルを複数実行することによって達成できます。使用されるアルゴリズムは、Percentage Closest Filtering または PCFと呼ばれています。このアルゴリズムは、9つのローカライズされたサンプル(3×3の行列)をシャドウマップから読み出します。硬い影の場合は1つのみです。

The shadow sampling type is specified per light and so the option can be found in the Light Inspector.

## パフォーマンスの考慮事項

影を有効にすると、パフォーマンスに影響があります：

* 指向性またはスポットライトを落とすそれぞれの影のために、すべてのフレームで一度シーンをシャドウマップにレンダリングする必要があります。ポイントライトの場合はシーンがライトごとに6回レンダリングされるので(シャドウマップが6面のキューブマップとして保存される)、負荷が大きくなります。シャドウマップの中にシーンをレンダリングすると、CPUとGPUの両方に負荷を加えます。
* シャドウマップの解像度を上げるとより鮮明な影を生成しますが、GPUはより多くのシャドウマップピクセルを埋める必要があり、フレームレートに影響を与える可能性があります。
* 影を受ける素材のシャドウサンプルタイプとしてソフトシャドウ(PCF3x3)を選択すると、ハードシャドウのオプションを使用した場合よりも、GPUに負荷がかかります。
* 影が環境の静的な部分から発生している場合は、[ライトマップ][4]を使用してテクスチャに影をbakeすることを検討してください。

[1]: /images/user-manual/graphics/lighting/shadows/doom3_shadows.jpg
[2]: /user-manual/packs/components/light
[3]: /images/user-manual/graphics/lighting/shadows/hard_vs_soft.jpg
[4]: /user-manual/graphics/lighting/lightmapping
[5]: /images/user-manual/scenes/components/component-light-directional.png
[6]: /images/user-manual/scenes/components/component-model.png

