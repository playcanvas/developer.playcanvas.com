"use strict";(self.webpackChunkdeveloper_playcanvas_com=self.webpackChunkdeveloper_playcanvas_com||[]).push([[9583],{46528:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var i=n(85893),r=n(11151);const a={title:"Real Time Multiplayer",tags:["multiplayer","networking"],thumb:"https://s3-eu-west-1.amazonaws.com/images.playcanvas.com/projects/12/406048/507186-image-75.jpg"},o=void 0,s={id:"tutorials/real-time-multiplayer",title:"Real Time Multiplayer",description:"This tutorial covers how to start creating your own multiplayer from scratch. If you prefer to use a hosted multiplayer service, we have tutorials for Colyseus and Photon.",source:"@site/docs/tutorials/real-time-multiplayer.md",sourceDirName:"tutorials",slug:"/tutorials/real-time-multiplayer",permalink:"/tutorials/real-time-multiplayer",draft:!1,unlisted:!1,editUrl:"https://github.com/playcanvas/developer.playcanvas.com/tree/dev/docs/tutorials/real-time-multiplayer.md",tags:[{label:"multiplayer",permalink:"/tags/multiplayer"},{label:"networking",permalink:"/tags/networking"}],version:"current",frontMatter:{title:"Real Time Multiplayer",tags:["multiplayer","networking"],thumb:"https://s3-eu-west-1.amazonaws.com/images.playcanvas.com/projects/12/406048/507186-image-75.jpg"},sidebar:"tutorialsSidebar",previous:{title:"Real-time Multiplayer with Photon",permalink:"/tutorials/real-time-multiplayer-photon"},next:{title:"Render 3D World to UI",permalink:"/tutorials/render-3d-world-to-ui"}},l={},c=[{value:"Setting up the Server",id:"setting-up-the-server",level:2},{value:"Setting up the Project",id:"setting-up-the-project",level:2},{value:"Server and Client Communication",id:"server-and-client-communication",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsxs)(t.p,{children:["This tutorial covers how to start creating your own multiplayer from scratch. If you prefer to use a hosted multiplayer service, we have tutorials for ",(0,i.jsx)(t.a,{href:"/tutorials/real-time-multiplayer-colyseus",children:"Colyseus"})," and ",(0,i.jsx)(t.a,{href:"/tutorials/real-time-multiplayer-photon",children:"Photon"}),"."]})}),"\n",(0,i.jsx)("div",{className:"iframe-container",children:(0,i.jsx)("iframe",{loading:"lazy",src:"https://playcanv.as/p/XFp1Ty3X/",title:"Real Time Multiplayer"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.em,{children:"Use WASD to move the player around. If you only see one capsule, try opening this page in another tab or on another computer."})}),"\n",(0,i.jsxs)(t.p,{children:["In this tutorial we\u2019ll cover how to setup a basic multiplayer project using Node.js and Socket.io. We\u2019ll focus on implementing it in PlayCanvas. By the end you should have a project similar to the one above. You can find the ",(0,i.jsx)(t.a,{href:"https://playcanvas.com/project/406048/overview/tutorial-realtime-multiplayer",children:"tutorial project here"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"setting-up-the-server",children:"Setting up the Server"}),"\n",(0,i.jsx)(t.p,{children:"We'll be implementing a client-server model (as opposed to peer-to-peer). This will be a basic server that will receive data from all clients (which are our PlayCanvas instances) and broadcast it back."}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://glitch.com/",children:"Glitch"})," provides a really convenient way to write and deploy backend apps for free completely in your browser! You can use it without an account but creating one will let you easily find your work. ",(0,i.jsx)(t.a,{href:"https://glitch.com/edit/#!/new-project",children:"Create a new Node app"})," and replace the contents of ",(0,i.jsx)(t.code,{children:"server.js"})," with this:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"var server = require('http').createServer();\nvar options = {\n  cors: true\n}\n\nvar io = require('socket.io')(server, options);\n\nio.sockets.on('connection', function(socket) {\n    console.log(\"Client has connected!\");\n});\n\nconsole.log ('Server started.');\nserver.listen(3000);\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Glitch will automatically re-run the server every time you finish typing. Once you\u2019ve copied this, you should get an error. Click on the ",(0,i.jsx)(t.code,{children:"Logs"})," button on the left side of the screen to open up the server console. Here you can see any server output, as well as the errors. You should see ",(0,i.jsx)(t.code,{children:"Error: Cannot find module 'socket.io'"}),"."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"/images/tutorials/multiplayer/glitch_error.png",alt:"Opening the log"})}),"\n",(0,i.jsxs)(t.p,{children:["To include a package, go to ",(0,i.jsx)(t.code,{children:"package.json"})," and click on the ",(0,i.jsx)(t.code,{children:"Add Package"})," button on the top. Search for ",(0,i.jsx)(t.code,{children:"socket.io"}),"."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"/images/tutorials/multiplayer/glitch_add_package.png",alt:"Adding a package"})}),"\n",(0,i.jsxs)(t.p,{children:["Now if you clear the log and add a space in ",(0,i.jsx)(t.code,{children:"server.js"})," so it re-runs, you should see ",(0,i.jsx)(t.code,{children:"Server started."})," in the log. You've successfully deployed a server! If you click the ",(0,i.jsx)(t.code,{children:"Show"})," button at the top, you won't actually see anything. This is because our server is not listening for any http requests, but instead it's listening for websocket requests."]}),"\n",(0,i.jsxs)(t.p,{children:["You can find the domain your server is deployed at by clicking in the top left (where it says ",(0,i.jsx)(t.code,{children:"thundering-polo"})," for me). This is where you can also rename the project."]}),"\n",(0,i.jsx)(t.p,{children:"This server will simply log a message every time someone connects. This should be enough to start working on our client and confirm that it connects to the server."}),"\n",(0,i.jsx)(t.h2,{id:"setting-up-the-project",children:"Setting up the Project"}),"\n",(0,i.jsx)(t.p,{children:"Create a new project on PlayCanvas. We first need to include the Socket.io client JS library, as an external script."}),"\n",(0,i.jsx)(t.p,{children:"Go to project settings."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"/images/tutorials/multiplayer/project_settings.png",alt:"Project settings"})}),"\n",(0,i.jsx)(t.p,{children:"Find and open 'External Scripts'."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"/images/tutorials/multiplayer/external_scripts_settings.png",alt:"External scripts settings"})}),"\n",(0,i.jsxs)(t.p,{children:["Change the value from 0 to 1 and add the CDN URL for the socket library from their ",(0,i.jsx)(t.a,{href:"https://cdnjs.com/libraries/socket.io",children:"framework server"}),". In this case, we will be using version 3.1.1 as that is the latest at time of writing:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"/images/tutorials/multiplayer/added_socket_io_library.png",alt:"Project settings"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.min.js\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Now we need to create a new script to handle the network logic. Create a new script called ",(0,i.jsx)(t.code,{children:"Network.js"}),". We first need to create a connection to the server. We can do this by adding this line in the initialize method:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"this.socket = io.connect('https://thundering-polo.glitch.me');\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Replace ",(0,i.jsx)(t.code,{children:"https://thundering-polo.glitch.me"})," with the address of your own server."]}),"\n",(0,i.jsxs)(t.p,{children:["To confirm that this works, attach this network script to the ",(0,i.jsx)(t.code,{children:"Root"})," entity, and then launch the game. Keep your eye on the server log at Glitch. If everything worked, the server should log ",(0,i.jsx)(t.code,{children:"Client has connected!"}),". The project is now setup to send and receive messages to & from the server."]}),"\n",(0,i.jsx)(t.h2,{id:"server-and-client-communication",children:"Server and Client Communication"}),"\n",(0,i.jsx)(t.p,{children:"The way you can send data between the client and server is with the socket connection we made earlier. To send data from the client (in Network.js on PlayCanvas), we use the emit function. Here\u2019s an example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"this.socket.emit ('playerJoined', 'John');\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This emits a message called ",(0,i.jsx)(t.code,{children:"playerJoined"}),", with the data ",(0,i.jsx)(t.code,{children:"John"}),". For the server to receive the message, we need to write in the server file (in server.js on Glitch):"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"socket.on ('playerJoined', function (name) {\n    console.log (name);\n});\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This will log whatever data is sent to the server when ",(0,i.jsx)(t.code,{children:"playerJoined"})," is emitted."]}),"\n",(0,i.jsx)(t.p,{children:"For this demo, we\u2019re aiming to have players move around with others in real time, so we'll need to create an environment. Start by create an entity to use as a ground, and add a collision box and static rigidbody. Here is what the settings on the ground entity should look like:"}),"\n",(0,i.jsx)("img",{loading:"lazy",src:"/images/tutorials/multiplayer/ground_entity.png",width:"360"}),"\n",(0,i.jsxs)(t.p,{children:["Next we\u2019ll need a player to control. Create a new capsule and call it ",(0,i.jsx)(t.code,{children:"Player"}),". add a dynamic rigidbody and collision box, and change the rigid body settings to match the picture below."]}),"\n",(0,i.jsx)("img",{loading:"lazy",src:"/images/tutorials/multiplayer/player_entity.png",width:"360"}),"\n",(0,i.jsxs)(t.p,{children:["Duplicate the player entity and rename it as 'Other'. Uncheck the ",(0,i.jsx)(t.code,{children:"Enabled"})," box on this new entity so that it's disabled to begin with.  This is the entity we'll be using to simulate other players in the game."]}),"\n",(0,i.jsxs)(t.p,{children:["Add a script component to your player, and attach a new script called ",(0,i.jsx)(t.code,{children:"Movement.js"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"var Movement = pc.createScript('movement');\n\nMovement.attributes.add('playerSpeed', {\n    type: 'number',\n    default: 30,\n    title: 'Player Speed'\n});\n\n// initialize code called once per entity\nMovement.prototype.initialize = function() {\n    this.force = new pc.Vec3();\n};\n\n// update code called every frame\nMovement.prototype.update = function(dt) {\n    var forward = this.entity.forward;\n    var right = this.entity.right;\n    var app = this.app;\n\n    x = 0;\n    z = 0;\n\n    if (app.keyboard.isPressed(pc.KEY_A)) {\n        x -= right.x;\n        z -= right.z;\n    }\n\n    if (app.keyboard.isPressed(pc.KEY_D)) {\n        x += right.x;\n        z += right.z;\n    }\n\n    if (app.keyboard.isPressed(pc.KEY_W)) {\n        x += forward.x;\n        z += forward.z;\n    }\n\n    if (app.keyboard.isPressed(pc.KEY_S)) {\n        x -= forward.x;\n        z -= forward.z;\n    }\n\n    if (x !== 0 || z !== 0) {\n        x *= dt;\n        z *= dt;\n\n        this.force.set (x, 0, z).normalize ().scale ((this.playerSpeed));\n        this.entity.rigidbody.applyForce (this.force);\n    }\n};\n"})}),"\n",(0,i.jsx)(t.p,{children:"When you launch the game you should be able to use WASD to move your player around. If not, you\u2019ve missed a step or did not set the correct settings for the entity. (Try changing the speed attribute on the movement script)\nFor the game to work in real time multiplayer, we need to keep track of all players in the game. Replace the current server code with this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"var server = require('http').createServer();\nvar options = {\n  cors: true\n}\n\nvar io = require('socket.io')(server, options);\n\nvar players = {};\n\nfunction Player (id) {\n    this.id = id;\n    this.x = 0;\n    this.y = 0;\n    this.z = 0;\n    this.entity = null;\n}\n\nio.sockets.on('connection', function(socket) {\n    socket.on ('initialize', function () {\n        var id = socket.id;\n        var newPlayer = new Player (id);\n        // Creates a new player object with a unique ID number.\n\n        players[id] = newPlayer;\n        // Adds the newly created player to the array.\n\n        socket.emit ('playerData', {id: id, players: players});\n        // Sends the connecting client his unique ID, and data about the other players already connected.\n\n        socket.broadcast.emit ('playerJoined', newPlayer);\n        // Sends everyone except the connecting player data about the new player.\n    });\n});\n\nconsole.log ('Server started.');\nserver.listen(3000);\n"})}),"\n",(0,i.jsxs)(t.p,{children:["In the code above, when a player sends the message ",(0,i.jsx)(t.code,{children:"initialize"}),", we send him his unique ID and data about other players in the game. It also tells others that a new player has connected. Let\u2019s add that logic into our Network script."]}),"\n",(0,i.jsxs)(t.p,{children:["Add this code in the ",(0,i.jsx)(t.code,{children:"initialize"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"// Your io.connect function call should be up here\n\nthis.socket.emit ('initialize');\nvar socket = this.socket;\n\nthis.player = this.app.root.findByName ('Player');\nthis.other = this.app.root.findByName ('Other');\n\nvar self = this;\nsocket.on ('playerData', function (data) {\n    self.initializePlayers (data);\n});\n\nsocket.on ('playerJoined', function (data) {\n    self.addPlayer (data);\n});\n"})}),"\n",(0,i.jsx)(t.p,{children:"And then declare these new functions inside Network.js:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"Network.prototype.initializePlayers = function (data) {\n    this.players = data.players;\n    // Create a player array and populate it with the currently connected players.\n\n    this.id = data.id;\n    // Keep track of what ID number you are.\n\n    for(var id in this.players){\n        if(id != Network.id){\n            this.players[id].entity = this.createPlayerEntity(this.players[id]);\n        }\n    }\n    // For every player already connected, create a new capsule entity.\n\n    this.initialized = true;\n    // Mark that the client has received data from the server.\n};\n\nNetwork.prototype.createPlayerEntity = function (data) {\n    var newPlayer = this.other.clone ();\n    // Create a new player entity.\n\n    newPlayer.enabled = true;\n    // Enable the newly created player.\n\n    this.other.getParent ().addChild (newPlayer);\n    // Add the entity to the entity hierarchy.\n\n    if (data)\n        newPlayer.rigidbody.teleport (data.x, data.y, data.z);\n    // If a location was given, teleport the new entity to the position of the connected player.\n\n    return newPlayer;\n    // Return the new entity.\n};\n\nNetwork.prototype.addPlayer = function (data) {\n    this.players[data.id] = data;\n    this.players[data.id].entity = this.createPlayerEntity(data);\n};\n"})}),"\n",(0,i.jsx)(t.p,{children:"Now when we join the game, the client tells the server we've connected, and the server sends us a list of players with their positions. The game then creates a new entity for each player connected, and moves them to their current position. The only problem is, the server doesn't know the positions of all players. We need to send the server our current position every frame."}),"\n",(0,i.jsxs)(t.p,{children:["Add this code into the ",(0,i.jsx)(t.code,{children:"initialize"})," of your Network.js script:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"socket.on ('playerMoved', function (data) {\n    self.movePlayer (data);\n});\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Replace your ",(0,i.jsx)(t.code,{children:"update"})," with this:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"Network.prototype.update = function (dt) {\n    this.updatePosition ();\n};\n"})}),"\n",(0,i.jsx)(t.p,{children:"And then declare these new functions inside Network.js:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"Network.prototype.movePlayer = function (data) {\n    if (this.initialized)\n        this.players[data.id].entity.rigidbody.teleport (data.x, data.y, data.z);\n};\n\nNetwork.prototype.updatePosition = function () {\n    if (this.initialized) {\n        var pos = this.player.getPosition ();\n        this.socket.emit ('positionUpdate', {id: this.id, x: pos.x, y: pos.y, z: pos.z});\n    }\n};\n"})}),"\n",(0,i.jsx)(t.p,{children:"Back on the server, we need to account for what happens when the player sends us their position. On the server, we need to add a new event:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"socket.on ('positionUpdate', function (data) {\n    players[data.id].x = data.x;\n    players[data.id].y = data.y;\n    players[data.id].z = data.z;\n\n    socket.broadcast.emit ('playerMoved', data);\n});\n"})}),"\n",(0,i.jsx)(t.p,{children:"When you're testing this, note that the server currently does not account for disconnects. To properly restart, you'll have to close all clients, restart the server (by typing in Glitch) then relaunching the clients."}),"\n",(0,i.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(t.p,{children:"That's about it! If you'd like, try adding some of these ideas on your own:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Players are removed when they close the game."}),"\n",(0,i.jsx)(t.li,{children:"Adding respawning functionality for when players fall off the edge."}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Keep in mind this is only a very basic implementation of multiplayer. Realistically, when creating larger multiplayer games you'll want to consider using an authoritative server, instead of handling all the game logic on the client. You can read a more in depth tutorial about ",(0,i.jsx)(t.a,{href:"https://code.tutsplus.com/tutorials/create-a-multiplayer-pirate-shooter-game-in-your-browser--cms-23311",children:"how Socket.io works and how to develop multiplayer in Javascript here"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["You can find the ",(0,i.jsx)(t.a,{href:"https://glitch.com/edit/#!/sore-bloom-beech",children:"full server code on Glitch here"}),", where you can also fork it and extend it."]})]})}function h(e={}){const{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},11151:(e,t,n)=>{n.d(t,{Z:()=>s,a:()=>o});var i=n(67294);const r={},a=i.createContext(r);function o(e){const t=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(a.Provider,{value:t},e.children)}}}]);